"use strict";function log(e,r){console[e]("[MON]",r),logger[e](new Date+": "+r)}function loadProperties(){try{var e=fs.readFileSync(settings.PROPS_FILE);return JSON.parse(e)}catch(r){throw Error("loadProps: "+r)}}function loadConfig(e){var r=fs.statSync(e);return r?fs.readFileSync(e):(log("error","config not found!"),null)}function run(){var e=dgram.createSocket("udp4"),r=dgram.createSocket("udp4"),t="",n=0,o={script:null};try{var i=loadProperties(settings.PROPS_FILE)}catch(s){return void log("error",s)}r.bind(i.mavlink,function(){r.on("message",function(e){parseJSON(e,function(e,r){e?log("error",e):reloader.emit("system:mavlink",r)})})});setInterval(function(){n++>5&&(t="",n=0,log("warn","No valid reply from server."))},1e3*settings.SESSION_TIMER);statusMon=setInterval(function(){var r,n=loadConfig(i.config);try{var s=JSON.parse(n.toString())}catch(a){log("error",a)}var c={op:"status"};s&&(s.drone&&""!==t||(c.email=s.email,c.password=s.password,c.serialId=s.serialId,c.op="connect",c.codeStatus=o),r=generateMsg(OP_STATUS,t,c),e.send(r,0,r.length,i.monitor.port,i.monitor.host))},1e3*settings.MONITOR_INTERVAL),reloader.on("system:mavlink",function(r){var n=generateMsg(OP_MAVLINK_TEXT,t,r);e.send(n,0,n.length,i.monitor.port,i.monitor.host)}),e.on("message",function(e,r){try{var s=parseMessage(e);n=0}catch(a){log("error",a)}s.session&&(t=s.session);var c=s.data;if(c.drone){var u=loadConfig(i.config);try{var l=JSON.parse(u.toString())}catch(a){log("error",a)}l.drone=c.drone,fs.writeFileSync(i.config,JSON.stringify(l))}c.codeBuffer&&null==o.script&&(log("info","Got CODE, running job."),runScript(null,o,c.codeBuffer,settings.CODE_EXEC))}),getEmitter().on("code:update",function(r){var n=generateMsg(OP_STATUS,t,{op:"code",msg:r,status:o});e.send(n,0,n.length,i.monitor.port,i.monitor.host)}),e.on("error",function(r){e.close(),log("error",r),setTimeout(function(){reloader.emit("reload")},1e3*settings.RELOAD_TIME)})}var fs=require("fs"),path=require("path"),console=require("console"),settings={PROPS_FILE:"properties.json",CODE_EXEC:"exec.pyc",CODE_LAUNCHER:"python",RELOAD_TIME:10,MONITOR_INTERVAL:1,SESSION_TIMER:5,MAV_SYSTEM:1,MAV_COMPONENT:1},output=fs.createWriteStream(path.resolve("./lucimon.log")),logger=new console.Console(output,output),events=require("events"),Mavlink=require("mavlink"),mav=new Mavlink(settings.MAV_SYSTEM,settings.MAV_COMPONENT),emitter=new events.EventEmitter;mav.on("ready",function(){mav.on("messasge",function(e){emitter.emit("message",e)}),emitter.setMaxListeners(Object.keys(mav.messagesByName).length);for(var e in mav.messagesByName)mav.on(e,function(e,r){emitter.emit("jsonmessage",{header:mav.getMessageName(e.id),data:r})});mav.on("error",function(e){emitter.emit("error",e)})});var parseBinary=function(e,r){mav.parse(e);var t=function(e){return emitter.removeListener("message",t),r(null,e)},n=function(e){return emitter.removeListener("error",n),r(e)};emitter.on("message",t),emitter.on("error",n)},parseJSON=function(e,r){mav.parse(e);var t=function(e){return emitter.removeListener("jsonmessage",t),r(null,e)},n=function(e){return emitter.removeListener("error",n),r(e)};emitter.on("jsonmessage",t),emitter.on("error",n)},cp=require("child_process"),codeEmitter=new events.EventEmitter,runScript=function(e,r,t,n){var o,i;i=n?n:path.resolve(settings.CODE_EXEC),o=t?cp.spawn(settings.CODE_LAUNCHER,[i,"--code",t]):cp.spawn(settings.CODE_LAUNCHER,[i,"--id",e]),r.script=o.pid,log("info","running from "+r.script),codeEmitter.emit("code:update","Running job "+r.script+"..."),o.on("close",function(e){isNaN(e)?log("warn","Process ended abnormally from SIG "+e):(log("info","Process ended "+e),codeEmitter.emit("code:update","App ended with exit code "+e+".")),r.script=null}),o.on("error",function(e){log("error",e),r.script=null}),o.stdout.on("data",function(e){log("trace","STDOUT "+e.toString()),codeEmitter.emit("code:update",e.toString())}),o.stderr.on("data",function(e){log("trace","STDERR "+e.toString()),codeEmitter.emit("code:update",e.toString()),r.script="error"})},getEmitter=function(){return codeEmitter},crypto=require("crypto"),crc=require("crc"),useCrypto=!0,SECURE_ALGO="aes-256-ctr",SECURE_KEY=new Buffer("d7 e6 af 0b 14 90 7e a5 0a fd e8 bb 57 4f 3d 99 81 88 d9 f5 1b 90 7d 3d 44 e7 94 e3 30 f0 55 d9".split(" ").map(function(e){return parseInt(e,16)}),"binary"),OP_STATUS=16,OP_CODE=17,OP_MAVLINK_TEXT=253,OP_MAVLINK_BIN=254,useEncryption=function(e){useCrypto=!!e},generateMsg=function(e,r,t){var n,o,i;switch(e){case OP_MAVLINK_BIN:break;case OP_MAVLINK_TEXT:case OP_STATUS:o=JSON.stringify(t);break;case OP_CODE:o=t;break;default:throw Error("Invalid opcode")}if(n=new Buffer(9+o.length),n.write(r,0,4,"hex"),n.writeUInt8(e,4),n.writeUInt16BE(o.length,5),n.write(o,7),i=crc.crc16(n.slice(0,7+o.length)),n.writeUInt16BE(i,7+o.length),useCrypto){var s=crypto.createCipher(SECURE_ALGO,SECURE_KEY),a=Buffer.concat([s.update(n),s["final"]()]);return a}return n},parseMessage=function(e){var r;if(useCrypto){var t=crypto.createDecipher(SECURE_ALGO,SECURE_KEY);r=Buffer.concat([t.update(e),t["final"]()])}else r=e;var n=crc.crc16(r.slice(0,r.length-2)),o=r.readUInt16BE(r.length-2);if(n!==o)return{error:"Checksum error"};var i=r.toString("hex",0,4),s=r.readUInt8(4),a=r.readUInt16BE(5),c={};switch(s){case OP_STATUS:case OP_MAVLINK_TEXT:try{c=JSON.parse(r.toString("utf8",7,a+7))}catch(u){throw Error("Invalid format")}break;case OP_CODE:c=r.toString("utf8",7,a+7);break;default:throw Error("Invalid opcode")}return{type:s,session:i,data:c}},dgram=require("dgram"),Emitter=require("events").EventEmitter,reloader=new Emitter,statusMon=null;reloader.on("reload",run),reloader.emit("reload");
