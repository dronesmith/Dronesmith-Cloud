<!doctype HTML>
<html lang="en">
<head>
  <base href="/">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>

        Forge

  </title>

  <link href="http://fonts.googleapis.com/css?family=Lato:100,300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="css/bootstrap.css"></link>
  <link rel="stylesheet" href="css/style.css"></link>
  <link rel="stylesheet" href="css/animations.css"></link>
  <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->
</head>
<body ng-app="Forge">

  <main class="container-fluid" ui-view></main>

  <script src="vendor/jquery.min.js"></script>
  <script src="vendor/bootstrap.min.js"></script>
  <script src="vendor/angular.min.js"></script>
  <script src="vendor/angular-route.min.js"></script>
  <script src="vendor/angular-resource.min.js"></script>
  <script src="vendor/angular-ui-router.min.js"></script>
  <script src="vendor/angular-animate.min.js"></script>
  <script src="vendor/ui-bootstrap.min.js"></script>
  <script src="vendor/ui-bootstrap-tpls.min.js"></script>

  <script>
  (function() {
    angular
      .module('Forge', [
        'ngRoute',
        'ngResource',
        'ui.router',
        'ngAnimate',
        'ui.bootstrap'
      ])

      .config(function(
        $httpProvider,
        $provide,
        $stateProvider,
        // $urlRouterProvider,
        $locationProvider) {

        $provide.factory('ServerErrorInterceptor',
          function($q, $injector, $rootScope) {
            return {
              response: function(response) {
                return response || $q.when(response);
              },

              responseError: function(rejection) {
                // TODO proper handling of 400s
                if (rejection.status === 500 || rejection.status === 400) {

                  // TODO this is cheap. Find a better solution.
                  // Note that $stateParams doesn't work.
                  $rootScope.ServerError = rejection.data;

                  $injector
                    .get('$state')
                    .go('error');
                }

                return $q.reject(rejection);
              }
            };
          })
        ;

        $stateProvider
          .state('login', {
            url:            '/',
            templateUrl:    'views/forge.html',
            controller:     'ForgeCtrl'
          })
          .state('error', {
            templateUrl:    '500.html',
            controller:     'ErrorCtrl'
          })
          .state('signup', {
            templateUrl:  'views/signup.html',
            controller:   'SignUpCtrl'
          })
        ;

        // FIXME not sure why this isn't working...
        // urlRouterProvider.otherwise('/');

        $locationProvider.html5Mode(true);
        $httpProvider.interceptors.push('ServerErrorInterceptor');
      })

      .controller('ErrorCtrl', function($scope, $rootScope) {
        $scope.error = $rootScope.ServerError
          || "The server didn't send back anything.";
      })

      .controller('ForgeCtrl', function($scope, $log, Session) {

        $scope.login = function() {
          Session.authenticate($scope.loginInfo);
        }
      })

      .controller('SignUpCtrl', function($scope, $log, Users) {
        $scope.signup = function() {
          // TODO POST account to User
          var user = new Users({
            username: 'Hurp2',
            password: 'durple500',
            confirmPassword: 'durple500',
            email: 'hurp@durp.com'
          })
            .$save();

          // TODO
          // Session.authenticate({});
        };

      })

      .factory('Users', ['$resource',
        function($resource) {
          return $resource('/api/user/:id', {
            userId: '@_id'
          }, {
            update: {
              method: 'PUT'
            }
          });
        }])

      .factory('Session', ['$resource',
        function($resource) {
          return $resource('/api/session/:id', {
            userId: '@_id'
          }, {
            sync: {
              method: 'PUT'
            },
            authenticate: {
              method: 'POST'
            }
          });
        }])

    ;
  })();
  </script>
</body>
</html>
